#!/bin/sh

# Check icon marker usage in library component code
echo "üîç Checking icon marker usage in library components..."

# Get staged library component files (exclude tests and stories)
COMPONENT_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
  grep "projects/truenas-ui/src/lib/" | \
  grep "\.ts$" | \
  grep -v "\.spec\.ts$" | \
  grep -v "\.stories\.ts$" | \
  grep -v "/test/" | \
  grep -v "/mocks/" | \
  grep -v "/fixtures/" | \
  grep -v "icon-marker\.ts$" || true)

if [ -n "$COMPONENT_FILES" ]; then
  # Check for tnIconMarker() in component code (should use libIconMarker instead)
  ICONMARKER_VIOLATIONS=$(echo "$COMPONENT_FILES" | xargs grep -l "tnIconMarker(" 2>/dev/null || true)

  if [ -n "$ICONMARKER_VIOLATIONS" ]; then
    echo ""
    echo "‚ùå Error: Library component code must use libIconMarker(), not tnIconMarker()"
    echo "   (Tests and stories can use tnIconMarker())"
    echo ""
    echo "   Files with violations:"
    echo "$ICONMARKER_VIOLATIONS" | sed 's/^/     - /'
    echo ""
    echo "   Fix: Replace tnIconMarker() with libIconMarker() and use explicit tn- prefix:"
    echo "     tnIconMarker('dataset', 'custom')  ‚Üí  libIconMarker('tn-dataset')"
    echo ""
    exit 1
  fi

  # Check for libIconMarker without tn- prefix
  LIBICON_VIOLATIONS=$(echo "$COMPONENT_FILES" | xargs grep -E "libIconMarker\(['\"][^t][^n][^-]" 2>/dev/null || true)

  if [ -n "$LIBICON_VIOLATIONS" ]; then
    echo ""
    echo "‚ùå Error: libIconMarker() must use tn- prefix"
    echo ""
    echo "   Violations found:"
    echo "$LIBICON_VIOLATIONS"
    echo ""
    echo "   Fix: Add tn- prefix to icon names:"
    echo "     libIconMarker('dataset')  ‚Üí  libIconMarker('tn-dataset')"
    echo ""
    exit 1
  fi

  echo "‚úÖ Icon marker usage looks good"
fi

echo ""
echo "‚ÑπÔ∏è  Note: Tests and builds run in CI, not in pre-commit hook"
echo "üì¶ Dist artifacts will be automatically generated after merge to main"
echo "‚úÖ Pre-commit checks passed"
echo ""
