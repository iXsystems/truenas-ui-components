<!-- Context menu content slot -->
@if (contextMenu()) {
  <div class="tn-menu-context-content" (contextmenu)="onContextMenu($event)">
    <ng-content />
  </div>
}

  <!-- Context menu template for overlay -->
  <ng-template #contextMenuTemplate>
    <div class="tn-menu" cdkMenu>
      @for (item of items(); track trackByItemId($index, item)) {
        @if (item.separator) {
          <div
            class="tn-menu-separator"
            role="separator"
          ></div>
        } @else {
          @if (!item.children || item.children.length === 0) {
            <button
              cdkMenuItem
              class="tn-menu-item"
              type="button"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
              (click)="onMenuItemClick(item)"
            >
              @if (item.icon) {
                <tn-icon size="sm" class="tn-menu-item-icon" [name]="item.icon" [library]="item.iconLibrary" />
              }
              <span class="tn-menu-item-label">{{ item.label }}</span>
              @if (item.shortcut) {
                <span class="tn-menu-item-shortcut">{{ item.shortcut }}</span>
              }
            </button>
          } @else {
            <button
              cdkMenuItem
              class="tn-menu-item tn-menu-item--nested"
              type="button"
              [cdkMenuTriggerFor]="nestedMenu"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
            >
              @if (item.icon) {
                <tn-icon size="sm" class="tn-menu-item-icon" [name]="item.icon" [library]="item.iconLibrary" />
              }
              <span class="tn-menu-item-label">{{ item.label }}</span>
              @if (item.shortcut) {
                <span class="tn-menu-item-shortcut">{{ item.shortcut }}</span>
              }
              <span class="tn-menu-item-arrow">▶</span>
            </button>

            <ng-template #nestedMenu>
              <div class="tn-menu tn-menu--nested" cdkMenu>
                @for (nestedItem of item.children; track trackByItemId($index, nestedItem)) {
                  @if (nestedItem.separator) {
                    <div
                      class="tn-menu-separator"
                      role="separator"
                    ></div>
                  } @else {
                    @if (!nestedItem.children || nestedItem.children.length === 0) {
                      <button
                        cdkMenuItem
                        class="tn-menu-item"
                        type="button"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                        (click)="onMenuItemClick(nestedItem)"
                      >
                        @if (nestedItem.icon) {
                          <tn-icon size="sm" class="tn-menu-item-icon" [name]="nestedItem.icon" [library]="nestedItem.iconLibrary" />
                        }
                        <span class="tn-menu-item-label">{{ nestedItem.label }}</span>
                        @if (nestedItem.shortcut) {
                          <span class="tn-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        }
                      </button>
                    } @else {
                      <button
                        cdkMenuItem
                        class="tn-menu-item tn-menu-item--nested"
                        type="button"
                        [cdkMenuTriggerFor]="deepNestedMenu"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                      >
                        @if (nestedItem.icon) {
                          <tn-icon size="sm" class="tn-menu-item-icon" [name]="nestedItem.icon" [library]="nestedItem.iconLibrary" />
                        }
                        <span class="tn-menu-item-label">{{ nestedItem.label }}</span>
                        @if (nestedItem.shortcut) {
                          <span class="tn-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        }
                        <span class="tn-menu-item-arrow">▶</span>
                      </button>

                      <ng-template #deepNestedMenu>
                        <div class="tn-menu tn-menu--nested" cdkMenu>
                          @for (deepNestedItem of nestedItem.children; track trackByItemId($index, deepNestedItem)) {
                            @if (deepNestedItem.separator) {
                              <div
                                class="tn-menu-separator"
                                role="separator"
                              ></div>
                            } @else {
                              <button
                                cdkMenuItem
                                class="tn-menu-item"
                                type="button"
                                [disabled]="deepNestedItem.disabled"
                                [class.disabled]="deepNestedItem.disabled"
                                (click)="onMenuItemClick(deepNestedItem)"
                              >
                                @if (deepNestedItem.icon) {
                                  <tn-icon size="sm" class="tn-menu-item-icon" [name]="deepNestedItem.icon" [library]="deepNestedItem.iconLibrary" />
                                }
                                <span class="tn-menu-item-label">{{ deepNestedItem.label }}</span>
                                @if (deepNestedItem.shortcut) {
                                  <span class="tn-menu-item-shortcut">{{ deepNestedItem.shortcut }}</span>
                                }
                              </button>
                            }
                          }
                        </div>
                      </ng-template>
                    }
                  }
                }
              </div>
            </ng-template>
          }
        }
      }
    </div>
  </ng-template>

  <!-- Regular menu template -->
  <ng-template #menuTemplate>
    <div class="tn-menu" cdkMenu>
      @for (item of items(); track trackByItemId($index, item)) {
        @if (item.separator) {
          <div
            class="tn-menu-separator"
            role="separator"
          ></div>
        } @else {
          @if (!item.children || item.children.length === 0) {
            <button
              cdkMenuItem
              class="tn-menu-item"
              type="button"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
              (click)="onMenuItemClick(item)"
            >
              @if (item.icon) {
                <tn-icon size="sm" class="tn-menu-item-icon" [name]="item.icon" [library]="item.iconLibrary" />
              }
              <span class="tn-menu-item-label">{{ item.label }}</span>
              @if (item.shortcut) {
                <span class="tn-menu-item-shortcut">{{ item.shortcut }}</span>
              }
            </button>
          } @else {
            <button
              cdkMenuItem
              class="tn-menu-item tn-menu-item--nested"
              type="button"
              [cdkMenuTriggerFor]="nestedMenu"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
            >
              @if (item.icon) {
                <tn-icon size="sm" class="tn-menu-item-icon" [name]="item.icon" [library]="item.iconLibrary" />
              }
              <span class="tn-menu-item-label">{{ item.label }}</span>
              @if (item.shortcut) {
                <span class="tn-menu-item-shortcut">{{ item.shortcut }}</span>
              }
              <span class="tn-menu-item-arrow">▶</span>
            </button>

            <ng-template #nestedMenu>
              <div class="tn-menu tn-menu--nested" cdkMenu>
                @for (nestedItem of item.children; track trackByItemId($index, nestedItem)) {
                  @if (nestedItem.separator) {
                    <div
                      class="tn-menu-separator"
                      role="separator"
                    ></div>
                  } @else {
                    @if (!nestedItem.children || nestedItem.children.length === 0) {
                      <button
                        cdkMenuItem
                        class="tn-menu-item"
                        type="button"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                        (click)="onMenuItemClick(nestedItem)"
                      >
                        @if (nestedItem.icon) {
                          <tn-icon size="sm" class="tn-menu-item-icon" [name]="nestedItem.icon" [library]="nestedItem.iconLibrary" />
                        }
                        <span class="tn-menu-item-label">{{ nestedItem.label }}</span>
                        @if (nestedItem.shortcut) {
                          <span class="tn-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        }
                      </button>
                    } @else {
                      <button
                        cdkMenuItem
                        class="tn-menu-item tn-menu-item--nested"
                        type="button"
                        [cdkMenuTriggerFor]="deepNestedMenu"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                      >
                        @if (nestedItem.icon) {
                          <tn-icon size="sm" class="tn-menu-item-icon" [name]="nestedItem.icon" [library]="nestedItem.iconLibrary" />
                        }
                        <span class="tn-menu-item-label">{{ nestedItem.label }}</span>
                        @if (nestedItem.shortcut) {
                          <span class="tn-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        }
                        <span class="tn-menu-item-arrow">▶</span>
                      </button>

                      <ng-template #deepNestedMenu>
                        <div class="tn-menu tn-menu--nested" cdkMenu>
                          @for (deepNestedItem of nestedItem.children; track trackByItemId($index, deepNestedItem)) {
                            @if (deepNestedItem.separator) {
                              <div
                                class="tn-menu-separator"
                                role="separator"
                              ></div>
                            } @else {
                              <button
                                cdkMenuItem
                                class="tn-menu-item"
                                type="button"
                                [disabled]="deepNestedItem.disabled"
                                [class.disabled]="deepNestedItem.disabled"
                                (click)="onMenuItemClick(deepNestedItem)"
                              >
                                @if (deepNestedItem.icon) {
                                  <tn-icon size="sm" class="tn-menu-item-icon" [name]="deepNestedItem.icon" [library]="deepNestedItem.iconLibrary" />
                                }
                                <span class="tn-menu-item-label">{{ deepNestedItem.label }}</span>
                                @if (deepNestedItem.shortcut) {
                                  <span class="tn-menu-item-shortcut">{{ deepNestedItem.shortcut }}</span>
                                }
                              </button>
                            }
                          }
                        </div>
                      </ng-template>
                    }
                  }
                }
              </div>
            </ng-template>
          }
        }
      }
    </div>
  </ng-template>