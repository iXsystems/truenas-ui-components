<div class="ix-menu-container" [class.ix-menu-container--context]="contextMenu" (contextmenu)="onContextMenu($event)">
  <button
    *ngIf="!contextMenu"
    [cdkMenuTriggerFor]="menu"
    [disabled]="disabled"
    class="ix-menu-trigger"
    [class.disabled]="disabled"
    [cdkMenuPosition]="getMenuPosition()"
    (cdkMenuOpened)="onMenuOpen()"
    (cdkMenuClosed)="onMenuClose()"
    type="button"
  >
    {{ triggerText }}
    <span class="ix-menu-arrow" [class.ix-menu-arrow--up]="position === 'above'">▼</span>
  </button>

  <!-- Context menu content slot -->
  <div *ngIf="contextMenu" class="ix-menu-context-content">
    <ng-content></ng-content>
  </div>

  <!-- Context menu template for overlay -->
  <ng-template #contextMenuTemplate>
    <div class="ix-menu" cdkMenu>
      <ng-container *ngFor="let item of items; trackBy: trackByItemId">
        <div
          *ngIf="item.separator; else menuItem"
          class="ix-menu-separator"
          role="separator"
        ></div>
        
        <ng-template #menuItem>
          <button
            *ngIf="!item.children || item.children.length === 0; else nestedMenuItem"
            cdkMenuItem
            [disabled]="item.disabled"
            [class.disabled]="item.disabled"
            class="ix-menu-item"
            (click)="onMenuItemClick(item)"
            type="button"
          >
            <span *ngIf="item.icon" class="ix-menu-item-icon">{{ item.icon }}</span>
            <span class="ix-menu-item-label">{{ item.label }}</span>
            <span *ngIf="item.shortcut" class="ix-menu-item-shortcut">{{ item.shortcut }}</span>
          </button>
          
          <ng-template #nestedMenuItem>
            <button
              cdkMenuItem
              [cdkMenuTriggerFor]="nestedMenu"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
              class="ix-menu-item ix-menu-item--nested"
              type="button"
            >
              <span *ngIf="item.icon" class="ix-menu-item-icon">{{ item.icon }}</span>
              <span class="ix-menu-item-label">{{ item.label }}</span>
              <span *ngIf="item.shortcut" class="ix-menu-item-shortcut">{{ item.shortcut }}</span>
              <span class="ix-menu-item-arrow">▶</span>
            </button>
            
            <ng-template #nestedMenu>
              <div class="ix-menu ix-menu--nested" cdkMenu>
                <ng-container *ngFor="let nestedItem of item.children; trackBy: trackByItemId">
                  <div
                    *ngIf="nestedItem.separator; else nestedMenuItemTemplate"
                    class="ix-menu-separator"
                    role="separator"
                  ></div>
                  
                  <ng-template #nestedMenuItemTemplate>
                    <button
                      *ngIf="!nestedItem.children || nestedItem.children.length === 0; else deepNestedMenuItem"
                      cdkMenuItem
                      [disabled]="nestedItem.disabled"
                      [class.disabled]="nestedItem.disabled"
                      class="ix-menu-item"
                      (click)="onMenuItemClick(nestedItem)"
                      type="button"
                    >
                      <span *ngIf="nestedItem.icon" class="ix-menu-item-icon">{{ nestedItem.icon }}</span>
                      <span class="ix-menu-item-label">{{ nestedItem.label }}</span>
                      <span *ngIf="nestedItem.shortcut" class="ix-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                    </button>
                    
                    <ng-template #deepNestedMenuItem>
                      <button
                        cdkMenuItem
                        [cdkMenuTriggerFor]="deepNestedMenu"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                        class="ix-menu-item ix-menu-item--nested"
                        type="button"
                      >
                        <span *ngIf="nestedItem.icon" class="ix-menu-item-icon">{{ nestedItem.icon }}</span>
                        <span class="ix-menu-item-label">{{ nestedItem.label }}</span>
                        <span *ngIf="nestedItem.shortcut" class="ix-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        <span class="ix-menu-item-arrow">▶</span>
                      </button>
                      
                      <ng-template #deepNestedMenu>
                        <div class="ix-menu ix-menu--nested" cdkMenu>
                          <ng-container *ngFor="let deepNestedItem of nestedItem.children; trackBy: trackByItemId">
                            <div
                              *ngIf="deepNestedItem.separator; else deepNestedMenuItemTemplate"
                              class="ix-menu-separator"
                              role="separator"
                            ></div>
                            
                            <ng-template #deepNestedMenuItemTemplate>
                              <button
                                cdkMenuItem
                                [disabled]="deepNestedItem.disabled"
                                [class.disabled]="deepNestedItem.disabled"
                                class="ix-menu-item"
                                (click)="onMenuItemClick(deepNestedItem)"
                                type="button"
                              >
                                <span *ngIf="deepNestedItem.icon" class="ix-menu-item-icon">{{ deepNestedItem.icon }}</span>
                                <span class="ix-menu-item-label">{{ deepNestedItem.label }}</span>
                                <span *ngIf="deepNestedItem.shortcut" class="ix-menu-item-shortcut">{{ deepNestedItem.shortcut }}</span>
                              </button>
                            </ng-template>
                          </ng-container>
                        </div>
                      </ng-template>
                    </ng-template>
                  </ng-template>
                </ng-container>
              </div>
            </ng-template>
          </ng-template>
        </ng-template>
      </ng-container>
    </div>
  </ng-template>

  <!-- Regular menu template -->
  <ng-template #menu>
    <div class="ix-menu" cdkMenu>
      <ng-container *ngFor="let item of items; trackBy: trackByItemId">
        <div
          *ngIf="item.separator; else menuItem"
          class="ix-menu-separator"
          role="separator"
        ></div>
        
        <ng-template #menuItem>
          <button
            *ngIf="!item.children || item.children.length === 0; else nestedMenuItem"
            cdkMenuItem
            [disabled]="item.disabled"
            [class.disabled]="item.disabled"
            class="ix-menu-item"
            (click)="onMenuItemClick(item)"
            type="button"
          >
            <span *ngIf="item.icon" class="ix-menu-item-icon">{{ item.icon }}</span>
            <span class="ix-menu-item-label">{{ item.label }}</span>
            <span *ngIf="item.shortcut" class="ix-menu-item-shortcut">{{ item.shortcut }}</span>
          </button>
          
          <ng-template #nestedMenuItem>
            <button
              cdkMenuItem
              [cdkMenuTriggerFor]="nestedMenu"
              [disabled]="item.disabled"
              [class.disabled]="item.disabled"
              class="ix-menu-item ix-menu-item--nested"
              type="button"
            >
              <span *ngIf="item.icon" class="ix-menu-item-icon">{{ item.icon }}</span>
              <span class="ix-menu-item-label">{{ item.label }}</span>
              <span *ngIf="item.shortcut" class="ix-menu-item-shortcut">{{ item.shortcut }}</span>
              <span class="ix-menu-item-arrow">▶</span>
            </button>
            
            <ng-template #nestedMenu>
              <div class="ix-menu ix-menu--nested" cdkMenu>
                <ng-container *ngFor="let nestedItem of item.children; trackBy: trackByItemId">
                  <div
                    *ngIf="nestedItem.separator; else nestedMenuItemTemplate"
                    class="ix-menu-separator"
                    role="separator"
                  ></div>
                  
                  <ng-template #nestedMenuItemTemplate>
                    <button
                      *ngIf="!nestedItem.children || nestedItem.children.length === 0; else deepNestedMenuItem"
                      cdkMenuItem
                      [disabled]="nestedItem.disabled"
                      [class.disabled]="nestedItem.disabled"
                      class="ix-menu-item"
                      (click)="onMenuItemClick(nestedItem)"
                      type="button"
                    >
                      <span *ngIf="nestedItem.icon" class="ix-menu-item-icon">{{ nestedItem.icon }}</span>
                      <span class="ix-menu-item-label">{{ nestedItem.label }}</span>
                      <span *ngIf="nestedItem.shortcut" class="ix-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                    </button>
                    
                    <ng-template #deepNestedMenuItem>
                      <button
                        cdkMenuItem
                        [cdkMenuTriggerFor]="deepNestedMenu"
                        [disabled]="nestedItem.disabled"
                        [class.disabled]="nestedItem.disabled"
                        class="ix-menu-item ix-menu-item--nested"
                        type="button"
                      >
                        <span *ngIf="nestedItem.icon" class="ix-menu-item-icon">{{ nestedItem.icon }}</span>
                        <span class="ix-menu-item-label">{{ nestedItem.label }}</span>
                        <span *ngIf="nestedItem.shortcut" class="ix-menu-item-shortcut">{{ nestedItem.shortcut }}</span>
                        <span class="ix-menu-item-arrow">▶</span>
                      </button>
                      
                      <ng-template #deepNestedMenu>
                        <div class="ix-menu ix-menu--nested" cdkMenu>
                          <ng-container *ngFor="let deepNestedItem of nestedItem.children; trackBy: trackByItemId">
                            <div
                              *ngIf="deepNestedItem.separator; else deepNestedMenuItemTemplate"
                              class="ix-menu-separator"
                              role="separator"
                            ></div>
                            
                            <ng-template #deepNestedMenuItemTemplate>
                              <button
                                cdkMenuItem
                                [disabled]="deepNestedItem.disabled"
                                [class.disabled]="deepNestedItem.disabled"
                                class="ix-menu-item"
                                (click)="onMenuItemClick(deepNestedItem)"
                                type="button"
                              >
                                <span *ngIf="deepNestedItem.icon" class="ix-menu-item-icon">{{ deepNestedItem.icon }}</span>
                                <span class="ix-menu-item-label">{{ deepNestedItem.label }}</span>
                                <span *ngIf="deepNestedItem.shortcut" class="ix-menu-item-shortcut">{{ deepNestedItem.shortcut }}</span>
                              </button>
                            </ng-template>
                          </ng-container>
                        </div>
                      </ng-template>
                    </ng-template>
                  </ng-template>
                </ng-container>
              </div>
            </ng-template>
          </ng-template>
        </ng-template>
      </ng-container>
    </div>
  </ng-template>
</div>