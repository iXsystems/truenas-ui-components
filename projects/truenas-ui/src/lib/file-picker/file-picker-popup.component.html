<!-- Header with breadcrumb navigation -->
<div class="ix-file-picker-header">
  <nav class="ix-file-picker-breadcrumb" aria-label="File path">
    @for (segment of currentPath() | tnTruncatePath; track $index; let last = $last) {
      <button
        class="breadcrumb-segment"
        [class.current]="last"
        [class.parent-nav]="segment.name === '..'"
        [disabled]="last"
        (click)="navigateToPath(segment.path)">
        {{ segment.name }}
      </button>
    }
  </nav>

  <div class="ix-file-picker-actions">
    @if (allowCreate()) {
      <tn-button
        variant="outline"
        label="New Folder"
        [disabled]="isCreateDisabled()"
        (onClick)="onCreateFolder()" />
    }
  </div>
</div>

<!-- Loading indicator -->
@if (loading()) {
  <div class="ix-file-picker-loading">
    <tn-icon name="loading" library="mdi" />
    <span>Loading...</span>
  </div>
}

<!-- File table -->
@if (!loading()) {
  <div class="ix-file-picker-content">
  <tn-table
    [dataSource]="filteredFileItems()"
    [displayedColumns]="multiSelect() ? displayedColumns : displayedColumns.slice(1)">

    <!-- Selection column -->
    @if (multiSelect()) {
      <ng-container tnColumnDef="select">
      <ng-template tnHeaderCellDef>
        <!-- Select all checkbox -->
      </ng-template>
      <ng-template let-item tnCellDef>
        <input 
          type="checkbox" 
          [checked]="isSelected(item)"
          [disabled]="!!item.disabled"
          (click)="$event.stopPropagation()"
          (change)="onItemClick(item)">
      </ng-template>
      </ng-container>
    }

    <!-- Name column -->
    <ng-container tnColumnDef="name">
      <ng-template tnHeaderCellDef>Name</ng-template>
      <ng-template let-item tnCellDef>

        <!-- NORMAL MODE: Display name -->
        @if (!item.isCreating) {
          <div
               class="file-name-cell"
               [class.disabled]="!!item.disabled"
               [class.zfs-object]="isZfsObject(item)"
               [attr.tabindex]="item.disabled ? null : 0"
               [attr.role]="'button'"
               (click)="onItemClick(item)"
               (dblclick)="onItemDoubleClick(item)"
               (keydown.enter)="onItemDoubleClick(item)"
               (keydown.space)="onItemClick(item)">
            <tn-icon
              [name]="getItemIcon(item)"
              [library]="getItemIconLibrary(item)"
              [class]="'file-icon file-icon-' + item.type" />
            <span class="file-name">{{ item.name }}</span>

            <!-- ZFS badge -->
            @if (isZfsObject(item)) {
              <span
                [class]="'zfs-badge zfs-badge-' + item.type">
                {{ getZfsBadge(item) }}
              </span>
            }

            <!-- Permission indicator -->
            @if (item.permissions === 'none') {
              <tn-icon
                name="lock"
                library="mdi"
                class="permission-icon" />
            }
          </div>
        }

        <!-- EDIT MODE: Inline name input with error display -->
        @if (item.isCreating) {
          <div class="file-name-cell-wrapper">
            <div class="file-name-cell editing" [class.has-error]="!!item.creationError">
              <tn-icon
                name="folder"
                library="mdi"
                class="file-icon file-icon-folder" />
              <input
                #folderNameInput
                type="text"
                role="textbox"
                aria-label="Folder name"
                class="folder-name-input"
                spellcheck="false"
                autocomplete="off"
                [class.error]="!!item.creationError"
                [value]="item.name"
                [disabled]="creationLoading()"
                [attr.data-autofocus]="true"
                (keydown)="onFolderNameKeyDown($event, item)"
                (blur)="onFolderNameInputBlur($event, item)">

              <!-- Loading indicator during submission -->
              @if (creationLoading()) {
                <tn-icon
                  name="loading"
                  library="mdi"
                  class="creation-loading-icon" />
              }
            </div>

            <!-- Inline error message -->
            @if (item.creationError) {
              <div class="folder-creation-error">
                <tn-icon name="alert-circle" library="mdi" class="error-icon" />
                <span class="error-text">{{ item.creationError }}</span>
              </div>
            }
          </div>
        }

      </ng-template>
    </ng-container>

    <!-- Size column -->
    <ng-container tnColumnDef="size">
      <ng-template tnHeaderCellDef>Size</ng-template>
      <ng-template let-item tnCellDef>
        @if (item.size !== undefined) {
          <span>{{ item.size | tnFileSize }}</span>
        }
        @if (item.size === undefined && item.type === 'folder') {
          <span class="folder-indicator">--</span>
        }
      </ng-template>
    </ng-container>

    <!-- Modified column -->
    <ng-container tnColumnDef="modified">
      <ng-template tnHeaderCellDef>Modified</ng-template>
      <ng-template let-item tnCellDef>
        @if (item.modified) {
          <span>{{ formatDate(item.modified) }}</span>
        }
      </ng-template>
    </ng-container>


  </tn-table>

  <!-- Empty state -->
  @if (filteredFileItems().length === 0) {
    <div class="empty-state">
      <tn-icon name="folder-open" library="mdi" />
      <p>No items found</p>
    </div>
  }
  </div>
}

<!-- Footer -->
@if (!loading()) {
  <div class="ix-file-picker-footer">
    @if (selectedItems().length > 0) {
      <span class="selection-count">
        {{ selectedItems().length }} item{{ selectedItems().length !== 1 ? 's' : '' }} selected
      </span>
    }
    @if (selectedItems().length === 0) {
      <span class="selection-count">
        No items selected
      </span>
    }
    <div class="footer-actions">
      <tn-button
        label="Select"
        [disabled]="selectedItems().length === 0"
        (onClick)="onSubmit()" />
    </div>
  </div>
}